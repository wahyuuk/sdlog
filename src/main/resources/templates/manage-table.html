<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Table</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/bootstrap-table.min.css}">
    <link rel="stylesheet" th:href="@{/css/bootstrap-datetimepicker.min.css}">
    <link rel="stylesheet" th:href="@{/css/bootstrap-theme.min.css}">
    <style>
        #ahmsdlog018ManageTableContainer {
            max-height: 520px;
            overflow-y: scroll;
            overflow-x: scroll;
            max-width: 100%;
        }

        #ahmsdlog018p02MaintainTableContainer {
            height: 575px;
        }

        #ahmsdlog018p02MaintainTableContainer .fixed-table-body {
            height: 500px !important;
        }

        #ahmsdlog018p02MaintainTableContainer .fixed-table-container {
            border-bottom: none !important;
        }

        #ahmsdlog018p02MaintainTableContainer .fixed-table-header {
            height: auto;
        }

        .ahmsdlog018p02PercepatanColWrapper {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .ahmsdlog018p02PercepatanColWrapper label.left {
            margin-right: 1rem;
        }

        .ahmsdlog018p02PercepatanColWrapper label.right {
            margin-left: 1rem;
        }

        .ahmsdlog018p02PercepatanColWrapper label.right,
        .ahmsdlog018p02PercepatanColWrapper label.left {
            font-size: 1.35rem;
        }
    </style>
</head>
<body>

<!--<div class="container">-->
<!--    <button class="btn btn-primary" onclick="ahmsdlog018p04ExportToExcel()">Generate Excel</button>-->
<!--    <div id="ahmsdlog018p04ReportMcTypeContainer">-->

<!--    </div>-->
<!--    <div id="ahmsdlog018p05ReportByDateContainer">-->

<!--    </div>-->
<!--</div>-->
<!--    <div class="container">-->
<!--        <input class="form-control" type="file" id="ahmsdlog018p03UploadFile">-->
<!--        <button class="btn btn-primary" onclick="ahmsdlog018p02GenerateExcel()">Generate Excel</button>-->
<!--        <button class="btn btn-primary" onclick="ahmsdlog018p03UploadExcel()">Upload Excel</button>-->
<!--        <button class="btn btn-primary" id="ahmsdlog018p03UploadSubmit" onclick="ahmsdlog018p02ManageOnUpdate()">Submit</button>-->
<!--    </div>-->
<!--    <div id="ahmsdlog018ManageUploadContainer">-->

<!--    </div>-->
<!--    <div id="ahmsdlog018ManageTableContainer">-->

<!--    </div>-->
<!--    <div class="container">-->
<!--        <button class="btn btn-primary" onclick="ahmsdlog018p02ManageOnUpdate()">Update</button>-->
<!--    </div>-->

    <div class="container">
        <div class="input-group date" id="ahmsdlog018p02MaintainDateUpdate">
            <input id="ahmsdlog018p02MaintainDateUpdateInput" type="text"
                   class="form-control" value="04-2021"/>
            <span class="input-group-addon">
            <span class="glyphicon glyphicon-calendar"></span>
        </span>
        </div>
        <div id="ahmsdlog018p02MaintainTableContainer"></div>
        <div id="ahmsdlog018p02MaintainButtonContainer">
            <button class="btn btn-primary" id="ahmsdlog018p02MaintainPrev" onclick="ahmsdlog018p02MaintainPrev()">Prev</button>
            <button class="btn btn-primary" id="ahmsdlog018p02MaintainNext" onclick="ahmsdlog018p02MaintainNext()">Next</button>
        </div>
    </div>

    <div id="ahmsdlog018p02PembukaanDoTableContainer">

    </div>

    <div class="container">
        <button class="btn btn-primary" onclick="ahmsdlog018p02PembukaanDoOnUpdate()">Update</button>
    </div>

</body>
<script th:src="@{/js/jQuery-2.1.3.min.js}"></script>
<script th:src="@{/js/bootstrap.min.js}"></script>
<script th:src="@{/js/bootstrap-table.js}"></script>
<script th:src="@{/js/moment-with-locales.min.js}"></script>
<script th:src="@{/js/bootstrap-datetimepicker.min.js}"></script>
<link th:href="@{/css/bootstrap-datetimepicker.min.css}" rel="stylesheet">
<script>
    let ahmsdlog018p02Columns = 0;
    let ahmsdlog018p02RequestDoData = null;
    let ahmsdlog018p02IsDataAlready = true;
    let ahmsdlog018p02PembukaanDoData = null;
    let ahmsdlog018p02MaintainRequestData = null;
    let ahmsdlog018p02MaintainDateList = null;
    let ahmsdlog018IsUpload = false;
    let ahmsdlog018p04ReportMcTypeData = null;
    let ahmsdlog018p05ReportByDateData = null;

    const shiptoData = [
        {
            shipto: 'S063'
        },
        {
            shipto: 'S039'
        }
    ];

    const ahmsdlog018MonthList = [
        'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
    ]

    let ahmsdlog018p02RequestApi = [];

    $(document).ready(() => {
        // ahmsdlog018p05ReportByDate();
        //
        // ahmsdlog018p02ManageTable();
        ahmsdlog018p02PembukaanDoTable();
        $('#ahmsdlog018p02MaintainDateUpdate').datetimepicker({
            format: 'DD MMM YYYY',
            viewMode: 'days',
            locale: 'en'
        });
        $('#ahmsdlog018p03UploadSubmit').attr("disabled", true);
        ahmsdlog018p02MaintainTable();
        // ahmsdlog018p04ReportByMCType();
    });

    function ahmsdlog018p05ReportByDate() {
        ahmsdlog018p02Columns = 0;

        $.ajax({
            url: '/report-by-date',
            type: 'POST',
            success: (res) => {
                ahmsdlog018p05ReportByDateData = res;
                $('#ahmsdlog018p05ReportByDateContainer').html(ahmsdlog018p05ReportByDateTableHead(res));
                $('#ahmsdlog018p05ReportDateTable').bootstrapTable({
                    data: res.rows
                });
            }
        })
    }

    function ahmsdlog018p05ReportByDateTableHead(data) {
        return `
            <table id="ahmsdlog018p05ReportDateTable"
                data-pagination="true" data-side-pagination="client" data-server-sort="false">
                <thead>
                    <th data-valign="middle" data-sortable="true" data-halign="center" data-field="dateMaintain" data-formatter="ahmsdlog018p05DateFormatter">Tanggal</th>
                    <th data-valign="middle" data-sortable="true" data-halign="center" data-field="day">Hari</th>
                    ${ahmsdlog018p05ReportByDateTableHeadNotReg(data)}
                    ${ahmsdlog018p05ReportByDateTableHeadReg(data)}
                    <th data-valign="middle" data-sortable="true" data-halign="center" data-formatter="ahmsdlog018p05TotalDOFormatter">
                        Total DO Open
                    </th>
                    <th data-valign="middle" data-sortable="true" data-halign="center" data-formatter="ahmsdlog018p05PercentageFormatter">
                        Cummulative DO Open Percentage
                    </th>
                </thead>
            </table>
        `;
    }

    function ahmsdlog018p05ReportByDateTableHeadNotReg(data) {
        let template = '';

        $.each(data.requestDo, (i, value) => {
            if(value.isRegular !== 'Y') {
                template += `
                    <th data-valign="middle" data-sortable="true" data-halign="center" data-field="${value.shipto}" data-formatter="ahmsdlog018p05DoFormatter">
                        ${data.requestDo[i].shiptoMd} - ${data.requestDo[i].city}
                    </th>
                `;
            }

            if(i == data.requestDo.length - 1) {
                template += `
                    <th data-valign="middle" data-sortable="true" data-halign="center" data-formatter="ahmsdlog018p05TotalQqFormatter">
                        Total (QQ)
                    </th>
                `;
            }
        });

        return template;
    }

    function ahmsdlog018p05ReportByDateTableHeadReg(data) {
        let template = '';

        $.each(data.requestDo, (i, value) => {
            if(value.isRegular === 'Y') {
                template += `
                    <th data-valign="middle" data-sortable="true" data-halign="center" data-field="${value.shipto}" data-formatter="ahmsdlog018p05DoFormatter">
                        ${data.requestDo[i].shiptoMd} - ${data.requestDo[i].city}
                    </th>
                `;
            }
        });

        return template;
    }

    function ahmsdlog018p05TotalQqFormatter(value, row, index) {
        const data = ahmsdlog018p05ReportByDateData;
        let total = 0;

        $.each(data.requestDo, (i, v) => {
            if(v.isRegular !== 'Y') {
                const shiptoDo = data.rows[index][v.shipto];
                total += shiptoDo ? shiptoDo : 0;
            }
        });

        ahmsdlog018p05ReportByDateData.rows[index].totalQq = total;

        return total;
    }

    function ahmsdlog018p05TotalDOFormatter(value, row, index) {
        const data = ahmsdlog018p05ReportByDateData;
        let total = 0;

        $.each(data.requestDo, (i, v) => {
            const shiptoDo = data.rows[index][v.shipto];
            total += shiptoDo ? shiptoDo : 0;
        });

        ahmsdlog018p05ReportByDateData.rows[index].totalDoOpen = total;

        return total;
    }

    function ahmsdlog018p05PercentageFormatter(value, row, index) {
        const data = ahmsdlog018p05ReportByDateData;

        if(index == 0) {
            const percent = (data.rows[index].totalDoOpen * 100) / data.totalReqDo;
            const percentage =Number(percent ? percent : 0);

            ahmsdlog018p05ReportByDateData.rows[index].percentageDo = percentage.toFixed(2);

            return percentage.toFixed(2) + "%";
        }

        const totalDoBefore = ahmsdlog018p05ReportByDateData.rows[index - 1].percentageDo;
        const percent = (data.rows[index].totalDoOpen * 100) / data.totalReqDo;
        const percentage = percent ? percent : 0 + ahmsdlog018ParseInt(totalDoBefore);

        ahmsdlog018p05ReportByDateData.rows[index].percentageDo = percentage.toFixed(2);

        return percentage.toFixed(2) + "%";
    }

    function ahmsdlog018p05DoFormatter(value, row, index) {
        const data = ahmsdlog018p05ReportByDateData;
        if(!value) {
            return 0;
        }

        return value;
    }

    function ahmsdlog018p05DateFormatter(value, row, index) {
        return ahmsdlog018GenerateFullDateFormat(value);
    }
    //end Report By Date

    function ahmsdlog018p04ReportByMCType() {
        $.ajax({
           url: '/report-mctype',
           type: 'POST',
           success: (res) => {
               ahmsdlog018p04ReportMcTypeData = res;
               $('#ahmsdlog018p04ReportMcTypeContainer').html(ahmsdlog018p04ReportByMCTypeTableInit());
               const table = $('#ahmsdlog018p04ReportMcTypeTable');
               table.bootstrapTable({
                   data: res.rows
               })
           }
        });
    }

    function ahmsdlog018p04ReportByMCTypeTableInit() {
        const data = ahmsdlog018p04ReportMcTypeData;

        let template = `
            <table id="ahmsdlog018p04ReportMcTypeTable"
                data-pagination="true" data-side-pagination="client" data-server-sort="false">
                <thead>
                    <th data-valign="middle" data-sortable="true" data-halign="center" data-field="mcTypeColor">MC Type Color</th>
                    <th data-valign="middle" data-sortable="true" data-halign="center" data-field="mcTypeId">MC Type Code</th>
                    <th data-valign="middle" data-sortable="true" data-halign="center" data-field="mcTypeDesc">MC Type Description</th>
                    <th data-valign="middle" data-sortable="true" data-halign="center" data-field="colorCode">MC Color Code</th>
                    <th data-valign="middle" data-sortable="true" data-halign="center" data-field="colorDesc">MC Color Description</th>
                    <th data-valign="middle" data-sortable="true" data-halign="center" data-field="distPlan">Distribution Plan</th>
                    ${ahmsdlog018p04McTypeTableHead()}
                    <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018p04DoPercentageFormatter">
                        DO Percentage
                    </th>
                </thead>
            </table>
        `;

        return template;
    }

    function ahmsdlog018p04McTypeTableHead() {
        const data = ahmsdlog018p04ReportMcTypeData;
        let template = '';

        for(let i = 0; i < data.requestDo.length; i++) {
            template += `
                <th data-valign="middle" data-sortable="true" data-halign="center" data-field="${data.requestDo[i].shipto}requestDo">
                    Request Do Open</br>
                    ${data.requestDo[i].shiptoMd} - ${data.requestDo[i].city}
                </th>
            `;

            if(i == data.requestDo.length - 1) {
                template += `
                <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018p04ReqDoTotalFormatter">
                    Total
                </th>
                <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018p04ReqDoSelisihFormatter">
                    Selisih
                </th>
            `;
            }
        }

        for(let i = 0; i < data.requestDo.length; i++) {
            template += `
                <th data-valign="middle" data-sortable="true" data-halign="center" data-field="${data.requestDo[i].shipto}Do">
                    Do Open</br>
                    ${data.requestDo[i].shiptoMd} - ${data.requestDo[i].city}
                </th>
            `;

            if(i == data.requestDo.length - 1) {
                template += `
                <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018p04DoTotalFormatter">
                    Total
                </th>
                <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018p04DoSelisihFormatter">
                    Selisih
                </th>
            `;
            }
        }

        return template;
    }

    function ahmsdlog018p04ReqDoTotalFormatter(value, row, index) {
        let total = 0;

        $.each(ahmsdlog018p04ReportMcTypeData.requestDo, (i, v) => {
           total +=  ahmsdlog018p04ReportMcTypeData.rows[index][`${v.shipto}requestDo`];
        });

        return total;
    }

    function ahmsdlog018p04ReqDoSelisihFormatter(value, row, index) {
        let total = 0;

        $.each(ahmsdlog018p04ReportMcTypeData.requestDo, (i, v) => {
            total +=  ahmsdlog018p04ReportMcTypeData.rows[index][`${v.shipto}requestDo`];
        });

        return row.distPlan - total;
    }

    function ahmsdlog018p04DoTotalFormatter(value, row, index) {
        let total = 0;

        $.each(ahmsdlog018p04ReportMcTypeData.requestDo, (i, v) => {
            total +=  ahmsdlog018p04ReportMcTypeData.rows[index][`${v.shipto}Do`];
        });

        return total;
    }

    function ahmsdlog018p04DoSelisihFormatter(value, row, index) {
        let total = 0;

        $.each(ahmsdlog018p04ReportMcTypeData.requestDo, (i, v) => {
            total +=  ahmsdlog018p04ReportMcTypeData.rows[index][`${v.shipto}Do`];
        });

        return row.distPlan - total;
    }

    function ahmsdlog018p04DoPercentageFormatter(value, row, index) {
        let totalDo = 0;
        let totalReqDo = 0;

        $.each(ahmsdlog018p04ReportMcTypeData.requestDo, (i, v) => {
            totalDo +=  ahmsdlog018p04ReportMcTypeData.rows[index][`${v.shipto}Do`];
            totalReqDo +=  ahmsdlog018p04ReportMcTypeData.rows[index][`${v.shipto}requestDo`];
        });

        const percent = ((totalDo * 100) / totalReqDo);

        return Math.round(percent ? percent : 0) + "%";
    }

    function ahmsdlog018p04ExportToExcel() {
        let data = ahmsdlog018p04ReportMcTypeData;
        let dataReq = {
            requestDo: data.requestDo,
            rows: []
        };

        $.each(data.rows, (i, v) => {
            let dataTemp = {
                mcTypeColor: v.mcTypeColor,
                mcTypeId: v.mcTypeId,
                colorCode: v.colorCode,
                mcTypeDesc: v.mcTypeDesc,
                colorDesc: v.colorDesc,
                disPlan: v.distPlan
            };

            let totalReqDo = 0;
            let totalDo = 0;
           $.each(data.requestDo, (j, value) => {
                dataTemp[`${value.shipto}ReqDo`] = v[`${value.shipto}requestDo`];
                dataTemp[`${value.shipto}Do`] = v[`${value.shipto}Do`];

                totalReqDo += v[`${value.shipto}requestDo`];
                totalDo += v[`${value.shipto}Do`];
           });

           const percent = ((totalDo * 100) / totalReqDo);
           dataTemp.totalReqDo = totalReqDo;
           dataTemp.totalDo = totalDo;
           dataTemp.selisihReqDo = v.distPlan - totalReqDo;
           dataTemp.selisihDo = v.distPlan - totalDo;
           dataTemp.percentageDo = Math.round(percent ? percent : 0) + "%";

           dataReq.rows.push(dataTemp);
        });

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/generate-excel-mctype');
        xhr.setRequestHeader('content-type', 'application/json');
        xhr.responseType = 'blob';
        xhr.send(JSON.stringify(dataReq));

        xhr.onload = function () {
            let url = xhr.getResponseHeader('Content-Disposition');
            url = url.split("=")[1];

            const blob = this.response;
            let downloadLink = window.document.createElement('a');
            downloadLink.href = window.URL.createObjectURL(blob);
            downloadLink.download = url;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
    }

    function ahmsdlog018GenerateMonth(date) {
        const dateTemp = new Date(`01-${date}`);

        return dateTemp.getMonth() + 1;
    }

    function ahmsdlog018GenerateYear(date) {
        const dateTemp = new Date(`01-${date}`);

        return dateTemp.getFullYear();
    }

    function ahmsdlog018GenerateDateFormat(date) {
        const dateTemp = new Date(`01-${date}`);

        return `${ahmsdlog018MonthList[dateTemp.getMonth()]}-${dateTemp.getFullYear()}`;
    }

    function ahmsdlog018GenerateDateRequest(date) {
        const dateValue = new Date(date);
        const month = dateValue.getMonth() + 1;
        const d = dateValue.getDate() < 10 ? `0${dateValue.getDate()}` : dateValue.getDate();
        const m = month < 10 ? `0${month}` : month;

        return `${dateValue.getFullYear()}-${m}-${d}`;
    }

    function ahmsdlog018GenerateFullDateFormat(date) {
        const dateTemp = new Date(date);

        const dateValue = dateTemp.getDate() < 10 ? `0${dateTemp.getDate()}` : dateTemp.getDate();

        return `${dateValue} ${ahmsdlog018MonthList[dateTemp.getMonth()]} ${dateTemp.getFullYear()}`;
    }

    function ahmsdlog018p02ManageTable() {
        const docNumber = 'DPC-202212001';
        const mdCode = 'G5Z';
        const period = 'Dec-2022';

        if(ahmsdlog018IsUpload) {
            $('#ahmsdlog018ManageUploadContainer').html(ahmsdlog018p02ManageTableHead(ahmsdlog018p02RequestDoData));

            const table = $('#ahmsdlog018p02ManageUploadTable');
            table.bootstrapTable({
                data: ahmsdlog018p02RequestDoData.rows
            });

            ahmsdlog018p02ManageTableFooter();

            return;
        }

        $.ajax({
            url: `/dp-color?no=${docNumber}&code=${mdCode}`,
            type: "GET",
            success: (res) => {
                ahmsdlog018p02RequestDoData = res;
                ahmsdlog018p02RequestApi = [];
                if(!res.requestDo.length) {
                    ahmsdlog018p02RequestDoData.requestDo = shiptoData;
                    ahmsdlog018p02IsDataAlready = false;
                }

                $('#ahmsdlog018ManageTableContainer').html(ahmsdlog018p02ManageTableHead(res));

                const table = $('#ahmsdlog018p02ManageTable');
                table.bootstrapTable({
                    data: res.rows
                });

                ahmsdlog018p02ManageTableFooter();
            }
        });
    }

    function ahmsdlog018p02ManageTableFooter() {
        const totalVinOld = ahmsdlog018p02RequestDoData.rows
            .reduce((total, value) => total + value.vinOld, 0);

        const totalVinNew = ahmsdlog018p02RequestDoData
            .rows.reduce((total, value) => total + value.vinNew, 0);

        let footerHtml = `
            <tr>
                <td colspan="6" style="text-align: center; font-weight: 700;">Total</td>
                <td style="font-weight: 700;">${totalVinOld}</td>
                <td style="font-weight: 700;">${totalVinNew}</td>
                <td style="font-weight: 700;">${totalVinOld + totalVinNew}</td>
        `;

        for (let i = 0; i < ahmsdlog018p02RequestDoData.requestDo.length; i++) {
            const vinOldSum = ahmsdlog018p02RequestDoData.rows
                .reduce((total, value) => total + value[`${ahmsdlog018p02RequestDoData.requestDo[i].shipto}VinOld`], 0);

            const vinNewSum = ahmsdlog018p02RequestDoData.rows
                .reduce((total, value) => total + value[`${ahmsdlog018p02RequestDoData.requestDo[i].shipto}VinNew`], 0);

            footerHtml += `
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02ManageTableVinTotalFooterOld${i}">
                        ${ahmsdlog018p02IsDataAlready ? vinOldSum : 0}
                    </span>
                </td>
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02ManageTableVinTotalFooterOld${i}">
                        ${ahmsdlog018p02IsDataAlready ? vinNewSum : 0}
                    </span>
                </td>
            `;
        }

        const totalRowData = ahmsdlog018p02RequestDoData.rows
            .reduce((total, value) => total + value.totalRowsData, 0);

        const selisihRowData = ahmsdlog018p02RequestDoData.rows
            .reduce((total, value) => total + value.totalRowsSelisih, 0);

        footerHtml += `
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02ManageTableVinTotalRowData">
                        ${totalRowData}
                    </span>
                </td>
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02ManageTableVinTotalRowSelisih">
                        ${selisihRowData}
                    </span>
                </td>
            `;

        if(!ahmsdlog018IsUpload) {
            $('#ahmsdlog018p02ManageTable tbody tr:last').after(footerHtml);
        } else {
            $('#ahmsdlog018p02ManageUploadTable tbody tr:last').after(footerHtml);
        }
    }

    function ahmsdlog018p02ManageTableHead() {
        let template = '';

        template += `
            <table id="${!ahmsdlog018IsUpload ?
                            'ahmsdlog018p02ManageTable' : 'ahmsdlog018p02ManageUploadTable'}">
                <thead>
                    <tr>
                        <th data-valign="middle" data-halign="center" data-field="unitGroup">Unit Group</th>
                        <th data-valign="middle" data-halign="center" data-field="mcTypeColor">Mc Type Color</th>
                        <th data-valign="middle" data-halign="center" data-field="mcTypeId">Mc Type Code</th>
                        <th data-valign="middle" data-halign="center" data-field="marketingDesc">Marketing Description</th>
                        <th data-valign="middle" data-halign="center" data-field="colorDesc">Color Description</th>
                        <th data-valign="middle" data-halign="center" data-field="colorCode">Color Code</th>
                        <th data-valign="middle" data-halign="center" data-field="vinOld">Vin Old</th>
                        <th data-valign="middle" data-halign="center" data-field="vinNew">Vin New</th>
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018p02MangeTotalVinFormatter">Total</th>
                        ${ahmsdlog018p02ManageTableHeadQq()}
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018p02ManageTotalFormatter">Total</th>
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018p02ManageSelisihFormatter">Selisih</th>
                    </tr>
                </thead>
            </table>
        `;

        return template;
    }

    function ahmsdlog018p02ManageTableHeadQq() {
        let template = '';
        $.each(ahmsdlog018p02RequestDoData.requestDo, (index, value) => {
           template += `
                <th data-valign="middle" data-halign="center" data-field="${value.shipto}VinOld" data-formatter="ahmsdlog018p02ManageTableVinOldFormatter">
                    ${value.shiptoMd} - ${value.city} <br>  Vin Old
                </th>
                <th data-valign="middle" data-halign="center" data-field="${value.shipto}VinNew" data-formatter="ahmsdlog018p02ManageTableVinNewFormatter">
                    ${value.shiptoMd} - ${value.city} <br>  Vin New
                </th>
           `;
        });

        return template;
    }

    function ahmsdlog018p02MangeTotalVinFormatter(value, row, index) {
        return `<span id="ahmsdlog018p02ManageTotalVin${index}">
                    ${row.vinOld + row.vinNew}
                </span>`
    }

    function ahmsdlog018p02ManageTableVinOldFormatter(value, row, index) {
        if(ahmsdlog018IsUpload) {
            return `<span id="ahmsdlog018p02DoOld${index}${ahmsdlog018p02Columns}">${value}</span>`;
        }

        return `<input type="number"
                    onchange="ahmsdlog018p02ManageOnChangeVin(event, value, 'Old', ${index}, ${ahmsdlog018p02Columns})"
                    class="form-control"
                    value="${value ? value : 0}"
                    id="ahmsdlog018p02DoOld${index}${ahmsdlog018p02Columns}"/>`
    }

    function ahmsdlog018p02ManageTableVinNewFormatter(value, row, index) {
        const lastCol = ahmsdlog018p02RequestDoData.requestDo.length - 1;

        let template = `<input type="number"
                             onchange="ahmsdlog018p02ManageOnChangeVin(event, value, 'New', ${index}, ${ahmsdlog018p02Columns})"
                             class="form-control"
                             value="${value ? value : 0}"
                             id="ahmsdlog018p02DoNew${index}${ahmsdlog018p02Columns}"/>`;

        if(ahmsdlog018IsUpload) {
            template = `<span id="ahmsdlog018p02DoNew${index}${ahmsdlog018p02Columns}">${value}</span>`;
        }

        if(ahmsdlog018p02Columns ==  lastCol) {
            ahmsdlog018p02Columns = 0;
        } else {
            ahmsdlog018p02Columns +=1;
        }

        return template;
    }

    function ahmsdlog018p02ManageTotalFormatter(value, row, index) {
        let total = 0;

        if(ahmsdlog018p02IsDataAlready) {
            $.each(ahmsdlog018p02RequestDoData.requestDo, (i, v) => {
                total += row[`${v.shipto}VinOld`];
                total += row[`${v.shipto}VinNew`];
            });
        }

        ahmsdlog018p02RequestDoData.rows[index].totalRowsData = total;

        return `<span id="ahmsdlog018p02ManageTotal${index}">${ahmsdlog018p02IsDataAlready ? total : 0}</span>`;
    }

    function ahmsdlog018p02ManageSelisihFormatter(value, row, index) {
        let total = row.vinOld + row.vinNew;

        if(ahmsdlog018p02IsDataAlready) {
            $.each(ahmsdlog018p02RequestDoData.requestDo, (i, v) => {
                total -= row[`${v.shipto}VinOld`];
                total -= row[`${v.shipto}VinNew`];
            });
        }

        ahmsdlog018p02RequestDoData.rows[index].totalRowsSelisih = total;

        return `<span id="ahmsdlog018p02ManageSelisih${index}">
                    ${ahmsdlog018p02IsDataAlready ? total : row.vinOld + row.vinNew}
                </span>`;
    }

    function ahmsdlog018p02ManageOnChangeVin(event, value, vin, index, columns) {
        const data = ahmsdlog018p02RequestDoData;
        const shipto = data.requestDo[columns];

        const targetValue = ahmsdlog018ParseInt(event.target.value);
        const vinOldValue = data.rows[index].vinOld;
        const vinNewValue = data.rows[index].vinNew;

        const totalVin = ahmsdlog018p02ManageTableCalculateTotalVin(index, vin);

        if(vin === 'Old' && totalVin > vinOldValue) {
            alert("Vin old melebihi distribution plan");
            $(`#${event.target.id}`).val(data.rows[index][`${shipto}VinOld`])
            event.preventDefault();
            return;
        } else if(vin === 'New' && totalVin > vinNewValue) {
            alert("Vin new melebihi distribution plan");
            $(`#${event.target.id}`).val(data.rows[index][`${shipto}VinNew`])
            event.preventDefault();
            return;
        }

        if(vin === 'Old') {
            data.rows[index][`${shipto}VinOld`] = ahmsdlog018ParseInt(targetValue);
            const footerValue = data.rows
                    .reduce((total, value) => total +
                        ahmsdlog018ParseInt(value[`${shipto}VinOld`]), 0);

            $('#ahmsdlog018p02ManageTableVinTotalFooterOld'+columns).text(footerValue);
        } else {
            data.rows[index][`${shipto}VinNew`] = ahmsdlog018ParseInt(targetValue);
            const footerValue = data.rows
                .reduce((total, value) => total +
                    ahmsdlog018ParseInt(value[`${shipto}VinNew`]), 0);

            $('#ahmsdlog018p02ManageTableVinTotalFooterNew'+columns).text(footerValue);
        }

        ahmsdlog018p02RequestApi.shipto = ahmsdlog018p02RequestDoData.requestDo;
        ahmsdlog018p02RequestApi.isUpdate = ahmsdlog018p02IsDataAlready;
    }

    function ahmsdlog018p02ManageTableCalculateTotalVin(index, vin) {
        const data = ahmsdlog018p02RequestDoData;
        let totalVin = 0;

        for (let i = 0; i < data.requestDo.length; i++) {
            const elementValue = $(`#ahmsdlog018p02Do${vin}${index}${i}`).val();

            totalVin += ahmsdlog018ParseInt(elementValue);
        }

        let totalSelisih = 0;
        let totalVinSelisih = 0;
        for (let i = 0; i < data.rows.length; i++) {
            const elementValue = $(`#ahmsdlog018p02ManageTotal${i}`).text();
            const elementValueSelisih = $(`#ahmsdlog018p02ManageSelisih${i}`).text();

            totalSelisih += ahmsdlog018ParseInt(elementValueSelisih);
            totalVinSelisih += ahmsdlog018ParseInt(elementValue);
        }

        $('#ahmsdlog018p02ManageTableVinTotalRowData').text(totalVinSelisih);
        $('#ahmsdlog018p02ManageTableVinTotalRowSelisih').text(totalSelisih);

        return totalVin;
    }

    function ahmsdlog018ParseInt(value) {
        return parseInt(value ? value : 0);
    }

    function ahmsdlog018p02ManageOnUpdate() {
        const docNumber = 'DPC-202212001';
        const mdCode = 'G5Z';
        const period = 'Dec-2022';
        let data = [];

        $.each(ahmsdlog018p02RequestDoData.rows, (i, v) => {
            $.each(ahmsdlog018p02RequestDoData.requestDo, (j, s) => {
                let vinOld = $(`#ahmsdlog018p02DoOld${i}${j}`).val();
                let vinNew = $(`#ahmsdlog018p02DoNew${i}${j}`).val();

                if(ahmsdlog018IsUpload) {
                    vinOld = $(`#ahmsdlog018p02DoOld${i}${j}`).text();
                    vinNew = $(`#ahmsdlog018p02DoNew${i}${j}`).text();
                }

                let dataReq = {
                    shipto: s.shipto,
                    shiptoMd: s.mdCode,
                    headVinOld : ahmsdlog018p02RequestDoData.rows[i].vinOld,
                    headVinNew: ahmsdlog018p02RequestDoData.rows[i].vinNew,
                    vinOld: ahmsdlog018ParseInt(vinOld),
                    vinNew: ahmsdlog018ParseInt(vinNew),
                    mcTypeId: ahmsdlog018p02RequestDoData.rows[i].mcTypeId,
                    unitGroupId: ahmsdlog018p02RequestDoData.rows[i].unitGroupId,
                    colorId: ahmsdlog018p02RequestDoData.rows[i].colorCode,
                    docNumber: docNumber,
                    mdCode: mdCode,
                    month: ahmsdlog018GenerateMonth(period),
                    year: ahmsdlog018GenerateYear(period),
                    sumDpQty: 100,
                    deviation: 2,
                    dpQty: 10
                };

                data.push(dataReq);
            })
        })

        $.ajax({
            url: '/manage-table',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: (res) => {
                console.log(res);
            },
            error: (err) => {
                console.log(err)
            }
        });
    }

    function ahmsdlog018p02PembukaanDoTable() {
        ahmsdlog018p02Columns = 0;

        $.ajax({
            url: '/pembukaan',
            type: 'POST',
            success: (res) => {
                ahmsdlog018p02PembukaanDoData = res;
                $('#ahmsdlog018p02PembukaanDoTableContainer').html(ahmsdlog018p02PembukaanDoTableHead(res));
                const table = $('#ahmsdlog018PembukaanDoTable');

                table.bootstrapTable({
                    data: res.rows
                })
            },
            error: (err) => {
                console.log(err);
            }
        });
    }

    function ahmsdlog018p02PembukaanDoTableHead(data) {
        let template = `
            <table id="ahmsdlog018PembukaanDoTable">
                <thead>
                    <tr>
                        <th data-field="date" data-valign="middle" data-halign="center" data-formatter="ahmsdlog018p02PembukaanDateFormatter"></th>

        `;

        $.each(data.requestDo, (i, v) => {
           template += `
                <th data-valign="middle" data-halign="center" data-field="${v.shipto}" data-formatter="ahmsdlog018p02PercepatanQQFormatter">
                    ${v.shiptoMd} - ${v.city}
                </th>
           `;
        });

        template += '</tr></thead></table>'

        return template;
    }

    function ahmsdlog018p02PembukaanDateFormatter(value, row, index) {
        return ahmsdlog018GenerateFullDateFormat(value);
    }

    function ahmsdlog018p02PercepatanQQFormatter(value, row, index) {
        const data = ahmsdlog018p02PembukaanDoData;
        const lastCol = data.requestDo.length - 1;
        const today = new Date('2022-12-12');
        const dateValue = new Date(data.rows[index].date);

        let template = `
            <div class="ahmsdlog018p02PercepatanColWrapper">
                <label class="left">No</label>
                <label class="switch" style="border-radius: 50%">
                    <input type="checkbox" onchange="ahmsdlog018p02PercepatanOnChecked(event, ${index}, ${ahmsdlog018p02Columns})"
                        id="ahmsdlog018p02PercepatanData${index}${ahmsdlog018p02Columns}"
                        ${value == 'Y' ? 'checked' : ''}
                        ${today >= dateValue ? 'disabled' : ''}
                     />
                    <span class="slider round"></span>
                </label>
                <label class="right">Yes</label>
            </div>
        `;

        if (ahmsdlog018p02Columns == lastCol) {
            ahmsdlog018p02Columns = 0;
            return template;
        }

        ahmsdlog018p02Columns++;

        return template;
    }

    function ahmsdlog018p02PercepatanOnChecked(event, rowTarget, colTarget) {
        const value = event.target.checked;
        const data = ahmsdlog018p02PembukaanDoData;
        ahmsdlog018p02PembukaanDoData.rows[rowTarget][data.requestDo[colTarget].shipto] = value ? 'Y' : 'T';
    }

    function ahmsdlog018p02PembukaanDoOnUpdate() {
        let data = ahmsdlog018p02PembukaanDoData;
        data.docNumber = 'DPC-202212001';
        data.mdCode = 'G5Z';

        $.ajax({
            url: '/pembukaan-save',
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            success: (res) => {
                console.log(res);
            },
            error: (err) => {
                console.log(err);
            }
        })
    }

    function ahmsdlog018p02MaintainTable() {
        const req = {
            docNumber: 'DPC-202212001',
            mdCode: 'G5Z'
        }

        $('#ahmsdlog018p02MaintainDateUpdate').on('dp.change', (e) => {
            ahmsdlog018p02MaintainTableInit();
        });

        $.ajax({
            url: '/get-date-maintain',
            type: 'POST',
            data: JSON.stringify(req),
            contentType: 'application/json',
            success: (res) => {
                ahmsdlog018p02MaintainDateList = res;
                $('#ahmsdlog018p02MaintainDateUpdateInput').val(ahmsdlog018GenerateFullDateFormat(res[0]));
                ahmsdlog018p02MaintainTableInit();
            }
        })

    }

    function ahmsdlog018p02MaintainTableInit() {
        const dateValue = $('#ahmsdlog018p02MaintainDateUpdateInput').val();
        const date = ahmsdlog018GenerateDateRequest(dateValue);

        ahmsdlog018p02Columns = 0;
        const req = {
            docNumber: 'DPC-202212001',
            mdCode: 'G5Z',
            dateMaintain: date
        }
        $.ajax({
            url: '/maintain',
            type: 'POST',
            data: JSON.stringify(req),
            contentType: 'application/json',
            success: (res) => {
                ahmsdlog018p02MaintainButtonConfig();
                ahmsdlog018p02MaintainRequestData = res;
                ahmsdlog018p02RequestApi = [];

                $('#ahmsdlog018p02MaintainTableContainer').html(ahmsdlog018p02MaintainTableHead(res));

                const table = $('#ahmsdlog018p02MaintainTable');
                table.bootstrapTable('destroy').bootstrapTable({
                    data: res.rows
                });
                ahmsdlog018p02MaintainTableFooter();
            }
        });
    }

    function ahmsdlog018p02MaintainTableHead(data) {
        let template = `
            <table id ="ahmsdlog018p02MaintainTable" data-height="500">
                <thead>
                    <tr>
                        <th data-valign="middle" data-halign="center" data-field="unitGroup">Unit Group</th>
                        <th data-valign="middle" data-halign="center" data-field="mcTypeColor">Mc Type Color</th>
                        <th data-valign="middle" data-halign="center" data-field="mcTypeId">Mc Type Code</th>
                        <th data-valign="middle" data-halign="center" data-field="marketingDesc">Marketing Description</th>
                        <th data-valign="middle" data-halign="center" data-field="colorDesc">Color Description</th>
                        <th data-valign="middle" data-halign="center" data-field="colorCode">Color Code</th>
                        <th data-valign="middle" data-halign="center" data-field="percentageReff">% Reff Accum</th>
                        <th data-valign="middle" data-halign="center" data-field="mpsVinOld">Mps Vin Old</th>
                        <th data-valign="middle" data-halign="center" data-field="mpsVinNew">Mps Vin New</th>
                        <th data-valign="middle" data-halign="center" data-field="ddsVinOld">Dds Vin Old</th>
                        <th data-valign="middle" data-halign="center" data-field="ddsVinNew">Dds Vin New</th>
                        ${ahmsdlog018p02MaintainTableQq(data)}
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018MaintainTableTotalPlanDoFormatter">
                            Total Plan Do Open
                        </th>
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018MaintainTableCummulativeFormatter">
                            Cummulative Plan DO Open (tgl 1-hari H)
                        </th>
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018MaintainTableSelisihFormatter">
                            Selisih Terhadap DDS
                        </th>
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018MaintainCumPercentageFormatter">
                            Cummulative Percentage (Unit Group)
                        </th>
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018MaintainRemarkFormatter">
                            Remark
                        </th>
                        <th data-valign="middle" data-halign="center" data-field="actualDoOpen">
                            Actual DO Open
                        </th>
                  </tr>
              </thead>
          </table>
        `;

        return template;
    }

    function ahmsdlog018p02MaintainTableQq(data) {
        let template = '';

        $.each(data.requestDo, (i, value) => {
            template += `
                <th data-valign="middle" data-halign="center" data-field="${value.shipto}HMinVinOld">
                    Sisa Pembukaan (H-1)<br>
                    ${value.shiptoMd} - ${value.city}<br> Vin Old
                </th>
                <th data-valign="middle" data-halign="center" data-field="${value.shipto}HMinVinNew">
                    Sisa Pembukaan (H-1)<br>
                    ${value.shiptoMd} - ${value.city}<br> Vin New
                </th>

                <th data-valign="middle" data-halign="center" data-field="${value.shipto}VinOld" data-formatter="ahmsdlog018p02MaintainTableVinOldFormatter">
                    ${value.shiptoMd} - ${value.city}<br> Vin Old
                </th>
                <th data-valign="middle" data-halign="center" data-field="${value.shipto}VinNew" data-formatter="ahmsdlog018p02MaintainTableVinNewFormatter">
                    ${value.shiptoMd} - ${value.city}<br> Vin New
                </th>

                <th data-valign="middle" data-halign="center" data-field="${value.shipto}HVinOld" data-formatter="ahmsdlog018p02MaintainTableVinOldHFormatter">
                    Sisa Pembukaan (H)<br>
                    ${value.shiptoMd} - ${value.city}<br> Vin Old
                </th>
                <th data-valign="middle" data-halign="center" data-field="${value.shipto}HVinNew" data-formatter="ahmsdlog018p02MaintainTableVinNewHFormatter">
                    Sisa Pembukaan (H)<br>
                    ${value.shiptoMd} - ${value.city}<br> Vin New
                </th>
           `;
        });

        return template;
    }

    function ahmsdlog018p02MaintainTableVinOldFormatter(value, row, index) {
        return `<input type="number"
                    onchange="ahmsdlog018p02MaintainOnChangeVin(event, value, 'Old', ${index}, ${ahmsdlog018p02Columns})"
                    class="form-control"
                    value="${value ? value : 0}"
                    id="ahmsdlog018p02MaintainDoOld${index}${ahmsdlog018p02Columns}"/>`
    }

    function ahmsdlog018p02MaintainTableVinNewFormatter(value, row, index) {
        return `<input type="number"
                     onchange="ahmsdlog018p02MaintainOnChangeVin(event, value, 'New', ${index}, ${ahmsdlog018p02Columns})"
                     class="form-control"
                     value="${value ? value : 0}"
                     id="ahmsdlog018p02MaintainDoNew${index}${ahmsdlog018p02Columns}"/>`;

    }

    function ahmsdlog018p02MaintainTableVinOldHFormatter(value, row, index) {
        return `<span id="ahmsdlog018p02MaintainHOld${ahmsdlog018p02Columns}${index}">${value}</span>`;
    }

    function ahmsdlog018p02MaintainTableVinNewHFormatter(value, row, index) {
        const lastCol = ahmsdlog018p02MaintainRequestData.requestDo.length - 1;
        const template = `<span id="ahmsdlog018p02MaintainHNew${ahmsdlog018p02Columns}${index}">${value}</span>`;

        if(ahmsdlog018p02Columns ==  lastCol) {
            ahmsdlog018p02Columns = 0;
        } else {
            ahmsdlog018p02Columns +=1;
        }

        return template;
    }

    function ahmsdlog018MaintainTableTotalPlanDoFormatter(value, row, index) {
        const data = ahmsdlog018p02MaintainRequestData;
        let totalPlanDo = 0;

        $.each(data.requestDo, (i, v) => {
           totalPlanDo += data.rows[i][`${v.shipto}VinOld`];
        });

        return `<span id="ahmsdlog018p02MaintainTotalPlanDo${index}">${totalPlanDo}</span>`;
    }

    function ahmsdlog018MaintainTableCummulativeFormatter(value, row, index) {
        return `<span id="ahmsdlog018p02MaintainCummlative${index}">125</span>`;
    }

    function ahmsdlog018MaintainTableSelisihFormatter(value, row, index) {
        let totalDds = row.ddsVinOld + row.ddsVinNew;
        let totalPlanDo = 0;

        $.each(ahmsdlog018p02MaintainRequestData.requestDo, (i, v) => {
            totalPlanDo += ahmsdlog018p02MaintainRequestData.rows[i][`${v.shipto}VinOld`];
        });

        return `<span id="ahmsdlog018p02MaintainSelisih${index}">${totalDds - totalPlanDo}</span>`;
    }

    function ahmsdlog018MaintainCumPercentageFormatter(value, row, index) {
        return `<span id="ahmsdlog018p02MaintainSelisih${index}">100%</span>`;
    }

    function ahmsdlog018MaintainRemarkFormatter(value, row, index) {
        return `<input type="text" class="form-control" id="ahmsdlog018p02MaintainRemark${index}" />`;
    }

    function ahmsdlog018p02MaintainTableFooter() {
        const data = ahmsdlog018p02MaintainRequestData;
        const totalDdsVinOld = data.rows
            .reduce((total, value) => total + value.ddsVinOld, 0);

        const totalDdsVinNew = data
            .rows.reduce((total, value) => total + value.ddsVinNew, 0);

        const totalMpsVinOld = data
            .rows.reduce((total, value) => total + value.mpsVinOld, 0);

        const totalMpsVinNew = data
            .rows.reduce((total, value) => total + value.mpsVinNew, 0);

        let footerHtml = `
            <tr>
                <td colspan="7" style="text-align: center; font-weight: 700;">Total</td>
                <td style="font-weight: 700;">${totalMpsVinOld}</td>
                <td style="font-weight: 700;">${totalMpsVinNew}</td>
                <td style="font-weight: 700;">${totalDdsVinOld}</td>
                <td style="font-weight: 700;">${totalDdsVinNew}</td>
        `;

        for (let i = 0; i < data.requestDo.length; i++) {
            const vinOldSum = data.rows
                .reduce((total, value) => total + value[`${data.requestDo[i].shipto}VinOld`], 0);

            const vinNewSum = data.rows
                .reduce((total, value) => total + value[`${data.requestDo[i].shipto}VinNew`], 0);

            const HMinVinOld = data.rows
                .reduce((total, value) => total + value[`${data.requestDo[i].shipto}HMinVinOld`], 0);

            const HMinVinNew = data.rows
                .reduce((total, value) => total + value[`${data.requestDo[i].shipto}HMinVinNew`], 0);

            const HVinOld = data.rows
                .reduce((total, value) => total + value[`${data.requestDo[i].shipto}HVinOld`], 0);

            const HVinNew = data.rows
                .reduce((total, value) => total + value[`${data.requestDo[i].shipto}HVinNew`], 0);

            footerHtml += `
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02MaintainTableHMinVinTotalFooterOld${i}">
                        ${ahmsdlog018p02IsDataAlready ? HMinVinOld : 0}
                    </span>
                </td>
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02MaintainTableHMinVinTotalFooterNew${i}">
                        ${ahmsdlog018p02IsDataAlready ? HMinVinNew : 0}
                    </span>
                </td>
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02MaintainTableVinTotalFooterOld${i}">
                        ${ahmsdlog018p02IsDataAlready ? vinOldSum : 0}
                    </span>
                </td>
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02MaintainTableVinTotalFooterNew${i}">
                        ${ahmsdlog018p02IsDataAlready ? vinNewSum : 0}
                    </span>
                </td>
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02MaintainTableHVinTotalFooterOld${i}">
                        ${ahmsdlog018p02IsDataAlready ? HVinOld : 0}
                    </span>
                </td>
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02MaintainTableHVinTotalFooterNew${i}">
                        ${ahmsdlog018p02IsDataAlready ? HVinNew : 0}
                    </span>
                </td>
            `;

            if (i == data.requestDo.length - 1) {
                const ddsVinOldSum = data.rows
                    .reduce((total, value) => total + value.ddsVinOld, 0);

                const ddsVinNewSum = data.rows
                    .reduce((total, value) => total + value.ddsVinNew, 0);

                const actualDoSum = data.rows
                    .reduce((total, value) => total + value.actualDoOpen, 0);

                footerHtml += `
                    <td style="font-weight: 700;">
                        <span id="ahmsdlog018p02MaintainTotalPlanFooter">
                            ${ahmsdlog018p02IsDataAlready ? vinOldSum + vinNewSum : 0}
                        </span>
                    </td>
                    <td></td>
                    <td style="font-weight: 700;">
                        <span id="ahmsdlog018p02MaintainSelisihFooter">
                            ${ahmsdlog018p02IsDataAlready ?
                        (ddsVinOldSum + ddsVinNewSum) - (vinOldSum + vinNewSum) : 0}
                        </span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="font-weight: 700;">
                        <span id="ahmsdlog018p02MaintainTableActualDoFooter">
                            ${ahmsdlog018p02IsDataAlready ? actualDoSum : 0}
                        </span>
                    </td>
                `;
            }
        }

        footerHtml += "</tr>";

        const table = $('#ahmsdlog018p02MaintainTable tbody tr:last').after(footerHtml);
    }

    function ahmsdlog018p02MaintainOnChangeVin(event, value, vin, index, columns) {
        const data = ahmsdlog018p02MaintainRequestData;
        const shipto = data.requestDo[columns].shipto;

        const targetValue = ahmsdlog018ParseInt(event.target.value);
        const vinOldValue = data.rows[index].ddsVinOld;
        const vinNewValue = data.rows[index].ddsVinNew;

        const totalVin = ahmsdlog018p02MaintainTableCalculateTotalVin(index, vin);

        if(vin === 'Old' && totalVin > vinOldValue) {
            alert("Vin old melebihi distribution plan");
            $(`#${event.target.id}`).val(data.rows[index][`${shipto}VinOld`])
            event.preventDefault();
            return;
        } else if(vin === 'New' && totalVin > vinNewValue) {
            alert("Vin new melebihi distribution plan");
            $(`#${event.target.id}`).val(data.rows[index][`${shipto}VinNew`])
            event.preventDefault();
            return;
        }

        if(vin === 'Old') {
            ahmsdlog018p02MaintainRequestData.rows[index][`${shipto}VinOld`] = ahmsdlog018ParseInt(targetValue);
            ahmsdlog018p02MaintainRequestData.rows[index][`${shipto}HVinOld`] =
                data.rows[index][`${shipto}HMinVinOld`] - ahmsdlog018ParseInt(targetValue);

            const footerValue = data.rows
                .reduce((total, value) => total + value[`${shipto}VinOld`], 0);

            $(`#ahmsdlog018p02MaintainHOld${columns}${index}`)
                .text(ahmsdlog018p02MaintainRequestData.rows[index][`${shipto}HVinOld`]);

            $(`#ahmsdlog018p02MaintainTableVinTotalFooterOld${columns}`).text(footerValue);
        } else {
            data.rows[index][`${shipto}VinNew`] = ahmsdlog018ParseInt(targetValue);
            ahmsdlog018p02MaintainRequestData.rows[index][`${shipto}HVinNew`] =
                data.rows[index][`${shipto}HMinVinNew`] - ahmsdlog018ParseInt(targetValue)

            const footerValue = data.rows
                .reduce((total, value) => total + value[`${shipto}VinNew`], 0);

            $(`#ahmsdlog018p02MaintainHNew${columns}${index}`)
                .text(ahmsdlog018p02MaintainRequestData.rows[index][`${shipto}HVinNew`]);

            $(`#ahmsdlog018p02MaintainTableVinTotalFooterNew${columns}`).text(footerValue);
        }

        const totalFooterHVin =
            ahmsdlog018p02MaintainRequestData
                .rows
                .reduce((total, value) => total + value[`${shipto}HVin${vin}`] ,0);

        $(`#ahmsdlog018p02MaintainTableHVinTotalFooter${vin}${columns}`).text(totalFooterHVin);
        ahmsdlog018p02MaintainRequestUpdateData(index, columns);
    }

    function ahmsdlog018p02MaintainRequestUpdateData(index, columns) {
        const data = ahmsdlog018p02MaintainRequestData
                .rows[index];
        const qq = ahmsdlog018p02MaintainRequestData.requestDo[columns];
        const date = $('#ahmsdlog018p02MaintainDateUpdateInput').val();

        const reqData = {
            docNumber : 'DPC-202212001',
            mdCode: 'G5Z',
            shiptoMd : qq.mdCode,
            shipto : qq.shipto,
            mcTypeId :data.mcTypeId,
            colorId : data.colorCode,
            dateMaintain : ahmsdlog018GenerateDateRequest(date),
            unitGroupId : data.unitGroupId,
            hVinOld: data[`${qq.shipto}HVinOld`],
            hVinNew: data[`${qq.shipto}HVinNew`],
            doVinOld : data[`${qq.shipto}VinOld`],
            doVinNew : data[`${qq.shipto}VinNew`],
            index: index
        }

        let indexOfData = null;
        for (let i = 0; i < ahmsdlog018p02RequestApi.length; i++) {
            if(ahmsdlog018p02RequestApi[i].index === index
                && ahmsdlog018p02RequestApi[i].shipto === qq.shipto) {

                indexOfData = i;
                break;
            }
        }

        if(indexOfData !== -1 && indexOfData != null) {
            ahmsdlog018p02RequestApi[indexOfData] = reqData;
            return;
        }

        ahmsdlog018p02RequestApi.push(reqData);
    }

    function ahmsdlog018p02MaintainTableCalculateTotalVin(index, vin) {
        const data = ahmsdlog018p02MaintainRequestData;
        let totalVin = 0;

        for (let i = 0; i < data.requestDo.length; i++) {
            const elementValue = $(`#ahmsdlog018p02MaintainDo${vin}${index}${i}`).val();

            totalVin += ahmsdlog018ParseInt(elementValue);
        }

        return totalVin;
    }

    function ahmsdlog018p02MaintainOnUpdate() {
        const data = ahmsdlog018p02RequestApi;

        $.ajax({
            url: '/maintain-update',
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            success: (res) => {
                ahmsdlog018p02MaintainTableInit();
            }
        });
    }

    function ahmsdlog018p02MaintainPrev() {
        const data = ahmsdlog018p02MaintainDateList;
        const dateInputValue = $('#ahmsdlog018p02MaintainDateUpdateInput').val();

        const index = data.indexOf(ahmsdlog018GenerateDateRequest(dateInputValue));
        const prevDate = ahmsdlog018GenerateFullDateFormat(data[index - 1]);

        $('#ahmsdlog018p02MaintainDateUpdateInput').val(prevDate);
        ahmsdlog018p02MaintainOnUpdate();
    }

    function ahmsdlog018p02MaintainNext() {
        const data = ahmsdlog018p02MaintainDateList;
        const dateInputValue = $('#ahmsdlog018p02MaintainDateUpdateInput').val();

        const index = data.indexOf(ahmsdlog018GenerateDateRequest(dateInputValue));
        const nextDate = ahmsdlog018GenerateFullDateFormat(data[index + 1]);

        $('#ahmsdlog018p02MaintainDateUpdateInput').val(nextDate);
        ahmsdlog018p02MaintainOnUpdate();
    }

    function ahmsdlog018p02MaintainButtonConfig() {
        const data = ahmsdlog018p02MaintainDateList;
        const dateInputValue = $('#ahmsdlog018p02MaintainDateUpdateInput').val();

        const index = data.indexOf(ahmsdlog018GenerateDateRequest(dateInputValue));

        if(index == 0) {
            $('#ahmsdlog018p02MaintainButtonContainer').html(
                `<button class="btn btn-primary" id="ahmsdlog018p02MaintainPrev" onclick="ahmsdlog018p02MaintainPrev()">Prev</button>
                 <button class="btn btn-primary" id="ahmsdlog018p02MaintainNext" onclick="ahmsdlog018p02MaintainNext()">Next</button>`);
            $('#ahmsdlog018p02MaintainPrev').attr('disabled', true);
        } else if(index == data.length - 1) {
            $('#ahmsdlog018p02MaintainButtonContainer').html(
                `<button class="btn btn-primary" id="ahmsdlog018p02MaintainPrev" onclick="ahmsdlog018p02MaintainPrev()">Prev</button>
                 <button class="btn btn-primary" id="ahmsdlog018p02MaintainNext" onclick="ahmsdlog018p02MaintainNext()">Next</button>`+
                '<button class="btn btn-primary" ' +
                'id="ahmsdlog018p02MaintainUpdate" ' +
                'onclick="ahmsdlog018p02MaintainSubmit()">' +
                'Submit</button>');

            $('#ahmsdlog018p02MaintainPrev').removeAttr('disabled');
            $('#ahmsdlog018p02MaintainNext').attr('disabled', true);

        } else {
            $('#ahmsdlog018p02MaintainButtonContainer').html(
                `<button class="btn btn-primary" id="ahmsdlog018p02MaintainPrev" onclick="ahmsdlog018p02MaintainPrev()">Prev</button>
                 <button class="btn btn-primary" id="ahmsdlog018p02MaintainNext" onclick="ahmsdlog018p02MaintainNext()">Next</button>`);
            $('#ahmsdlog018p02MaintainPrev').removeAttr('disabled');
            $('#ahmsdlog018p02MaintainNext').removeAttr('disabled');
        }
    }

    function ahmsdlog018p02MaintainSubmit() {
        ahmsdlog018p02MaintainOnUpdate();

        const data = {
            docNumber: 'DPC-202212001',
            mdCode: 'G5Z'
        }

        $.ajax({
            url: '/submit-maintain',
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            success: (res) => {
                console.log(res)
            }
        })
    }

    function ahmsdlog018p02GenerateExcel() {
        let data = ahmsdlog018p02RequestDoData
        const rows = data.rows.map(r => {
            let data = {
                ...r,
                unitGroup: `${r.unitGroupId} - ${r.unitGroup}`
            }

            return data;
        });

        data.rows = rows;
        data.docNumber = 'DPC-202212001';
        data.period = 'Dec 2022';
        data.mainDealer = 'G5Z - ABC';

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/downloadexcelshiptoqqlist');
        xhr.setRequestHeader('content-type', 'application/json');
        xhr.responseType = 'blob';
        xhr.send(JSON.stringify(data));

        xhr.onload = function () {
            let url = xhr.getResponseHeader('Content-Disposition');
            url = url.split("=")[1];

            const blob = this.response;
            let downloadLink = window.document.createElement('a');
            downloadLink.href = window.URL.createObjectURL(blob);
            downloadLink.download = url;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
    }

    function ahmsdlog018p03UploadExcel() {
        let formData = new FormData();

        formData.append('file',
            $('#ahmsdlog018p03UploadFile').prop('files')[0]);

        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: (res) => {
                ahmsdlog018IsUpload = true;
                ahmsdlog018p02RequestDoData = res;
                ahmsdlog018p02ManageTable();
                $('#ahmsdlog018p03UploadSubmit').removeAttr("disabled");
            }
        });
    }
</script>
</html>