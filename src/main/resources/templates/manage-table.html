<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Table</title>
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.15.5/dist/bootstrap-table.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <style>
        #ahmsdlog018ManageTableContainer {
            max-height: 520px;
            overflow-y: scroll;
            overflow-x: scroll;
            max-width: 100%;
        }

        .ahmsdlog018p02PercepatanColWrapper {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .ahmsdlog018p02PercepatanColWrapper label.left {
            margin-right: 1rem;
        }

        .ahmsdlog018p02PercepatanColWrapper label.right {
            margin-left: 1rem;
        }

        .ahmsdlog018p02PercepatanColWrapper label.right,
        .ahmsdlog018p02PercepatanColWrapper label.left {
            font-size: 1.35rem;
        }
    </style>
</head>
<body>
    <div id="ahmsdlog018ManageTableContainer">

    </div>
    <div class="container">
        <button class="btn btn-primary" onclick="ahmsdlog018p02MaintainOnUpdate()">Update</button>
    </div>

    <div id="ahmsdlog018p02PembukaanDoTableContainer">

    </div>

<!--    <div class="container">-->
<!--        <button class="btn btn-primary" onclick="ahmsdlog018p02PembukaanDoOnUpdate()">Update</button>-->
<!--    </div>-->

    <div id="ahmsdlog018p02MaintainTableContainer"></div>

<script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
<script src="https://unpkg.com/bootstrap-table@1.15.5/dist/bootstrap-table.min.js"></script>
</body>
<script>
    let ahmsdlog018p02Columns = 0;
    let ahmsdlog018p02RequestDoData = null;
    let ahmsdlog018p02IsDataAlready = true;
    let ahmsdlog018p02PembukaanDoData = null;
    let ahmsdlog018p02MaintainRequestData = null;
    const shiptoData = [
        {
            shipto: 'S063'
        },
        {
            shipto: 'S039'
        }
    ];

    const ahmsdlog018MonthList = [
        'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
    ]

    let ahmsdlog018p02RequestApi = {};

    $(document).ready(() => {
        // ahmsdlog018p02ManageTable();
        // ahmsdlog018p02PembukaanDoTable();
        ahmsdlog018p02MaintainTable();
    });

    function ahmsdlog018GenerateMonth(date) {
        const dateTemp = new Date(`01-${date}`);

        return dateTemp.getMonth();
    }

    function ahmsdlog018GenerateYear(date) {
        const dateTemp = new Date(`01-${date}`);

        return dateTemp.getFullYear();
    }

    function ahmsdlog018GenerateDateFormat(date) {
        const dateTemp = new Date(`01-${date}`);

        return `${ahmsdlog018MonthList[dateTemp.getMonth()]}-${dateTemp.getFullYear()}`;
    }

    function ahmsdlog018GenerateFullDateFormat(date) {
        const dateTemp = new Date(date);

        const dateValue = dateTemp.getDate() < 10 ? `0${dateTemp.getDate()}` : dateTemp.getDate();

        return `${dateValue} ${ahmsdlog018MonthList[dateTemp.getMonth()]} ${dateTemp.getFullYear()}`;
    }

    function ahmsdlog018p02ManageTable() {
        const docNumber = 'DPC-202212001';
        const mdCode = 'G5Z';
        const period = 'Dec-2022';

        $.ajax({
            url: `/dp-color?no=${docNumber}&code=${mdCode}`,
            type: "GET",
            success: (res) => {
                ahmsdlog018p02RequestDoData = res;
                ahmsdlog018p02RequestApi = [];

                if(!res.requestDo.length) {
                    ahmsdlog018p02RequestDoData.requestDo = shiptoData.map(d => d.shipto);
                    ahmsdlog018p02IsDataAlready = false;
                }

                $('#ahmsdlog018ManageTableContainer').html(ahmsdlog018p02ManageTableHead(res));
                const table = $('#ahmsdlog018p02ManageTable');
                table.bootstrapTable({
                    data: res.rows,
                    fixedColumns: true,
                    fixedNumber: 7,
                    fixedRightNumber: 1
                });

                ahmsdlog018p02ManageTableFooter();
            }
        });
    }

    function ahmsdlog018p02ManageTableFooter() {
        const totalVinOld = ahmsdlog018p02RequestDoData.rows
            .reduce((total, value) => total + value.vinOld, 0);

        const totalVinNew = ahmsdlog018p02RequestDoData
            .rows.reduce((total, value) => total + value.vinNew, 0);

        let footerHtml = `
            <tr>
                <td colspan="6" style="text-align: center; font-weight: 700;">Total</td>
                <td style="font-weight: 700;">${totalVinOld}</td>
                <td style="font-weight: 700;">${totalVinNew}</td>
                <td style="font-weight: 700;">${totalVinOld + totalVinNew}</td>
        `;

        for (let i = 0; i < ahmsdlog018p02RequestDoData.requestDo.length; i++) {
            const vinOldSum = ahmsdlog018p02RequestDoData.rows
                .reduce((total, value) => total + value[`${ahmsdlog018p02RequestDoData.requestDo[i]}VinOld`], 0);

            const vinNewSum = ahmsdlog018p02RequestDoData.rows
                .reduce((total, value) => total + value[`${ahmsdlog018p02RequestDoData.requestDo[i]}VinNew`], 0);

            footerHtml += `
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02ManageTableVinTotalFooterOld${i}">
                        ${ahmsdlog018p02IsDataAlready ? vinOldSum : 0}
                    </span>
                </td>
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02ManageTableVinTotalFooterOld${i}">
                        ${ahmsdlog018p02IsDataAlready ? vinNewSum : 0}
                    </span>
                </td>
            `;
        }

        const totalRowData = ahmsdlog018p02RequestDoData.rows
            .reduce((total, value) => total + value.totalRowsData, 0);

        const selisihRowData = ahmsdlog018p02RequestDoData.rows
            .reduce((total, value) => total + value.totalRowsSelisih, 0);

        footerHtml += `
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02ManageTableVinTotalRowData">
                        ${totalRowData}
                    </span>
                </td>
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02ManageTableVinTotalRowSelisih">
                        ${selisihRowData}
                    </span>
                </td>
            `;

        const table = $('#ahmsdlog018p02ManageTable tbody tr:last').after(footerHtml);
    }

    function ahmsdlog018p02ManageTableHead() {
        let template = '';

        template += `
            <table id="ahmsdlog018p02ManageTable">
                <thead>
                    <tr>
                        <th data-valign="middle" data-halign="center" data-field="unitGroup">Unit Group</th>
                        <th data-valign="middle" data-halign="center" data-field="mcTypeColor">Mc Type Color</th>
                        <th data-valign="middle" data-halign="center" data-field="mcTypeId">Mc Type Code</th>
                        <th data-valign="middle" data-halign="center" data-field="marketingDesc">Marketing Description</th>
                        <th data-valign="middle" data-halign="center" data-field="colorDesc">Color Description</th>
                        <th data-valign="middle" data-halign="center" data-field="colorCode">Color Code</th>
                        <th data-valign="middle" data-halign="center" data-field="vinOld">Vin Old</th>
                        <th data-valign="middle" data-halign="center" data-field="vinNew">Vin New</th>
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018p02MangeTotalVinFormatter">Total</th>
                        ${ahmsdlog018p02ManageTableHeadQq()}
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018p02ManageTotalFormatter">Total</th>
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018p02ManageSelisihFormatter">Selisih</th>
                    </tr>
                </thead>
            </table>
        `;

        return template;
    }

    function ahmsdlog018p02ManageTableHeadQq() {
        let template = '';
        $.each(ahmsdlog018p02RequestDoData.requestDo, (index, value) => {
           template += `
                <th data-valign="middle" data-halign="center" data-field="${value}VinOld" data-formatter="ahmsdlog018p02ManageTableVinOldFormatter">
                    ${value} Vin Old
                </th>
                <th data-valign="middle" data-halign="center" data-field="${value}VinNew" data-formatter="ahmsdlog018p02ManageTableVinNewFormatter">
                    ${value} Vin New
                </th>
           `;
        });

        return template;
    }

    function ahmsdlog018p02MangeTotalVinFormatter(value, row, index) {
        return `<span id="ahmsdlog018p02ManageTotalVin${index}">
                    ${row.vinOld + row.vinNew}
                </span>`
    }

    function ahmsdlog018p02ManageTableVinOldFormatter(value, row, index) {
        return `<input type="number"
                    onchange="ahmsdlog018p02ManageOnChangeVin(event, value, 'Old', ${index}, ${ahmsdlog018p02Columns})"
                    class="form-control"
                    value="${value ? value : 0}"
                    id="ahmsdlog018p02DoOld${index}${ahmsdlog018p02Columns}"/>`
    }

    function ahmsdlog018p02ManageTableVinNewFormatter(value, row, index) {
        const lastCol = ahmsdlog018p02RequestDoData.requestDo.length - 1;

        const template = `<input type="number"
                             onchange="ahmsdlog018p02ManageOnChangeVin(event, value, 'New', ${index}, ${ahmsdlog018p02Columns})"
                             class="form-control"
                             value="${value ? value : 0}"
                             id="ahmsdlog018p02DoNew${index}${ahmsdlog018p02Columns}"/>`;

        if(ahmsdlog018p02Columns ==  lastCol) {
            ahmsdlog018p02Columns = 0;
        } else {
            ahmsdlog018p02Columns +=1;
        }

        return template;
    }

    function ahmsdlog018p02ManageTotalFormatter(value, row, index) {
        let total = 0;

        if(ahmsdlog018p02IsDataAlready) {
            $.each(ahmsdlog018p02RequestDoData.requestDo, (i, v) => {
                total += row[`${v}VinOld`];
                total += row[`${v}VinNew`];
            });
        }

        ahmsdlog018p02RequestDoData.rows[index].totalRowsData = total;

        return `<span id="ahmsdlog018p02ManageTotal${index}">${ahmsdlog018p02IsDataAlready ? total : 0}</span>`;
    }

    function ahmsdlog018p02ManageSelisihFormatter(value, row, index) {
        let total = row.vinOld + row.vinNew;

        if(ahmsdlog018p02IsDataAlready) {
            $.each(ahmsdlog018p02RequestDoData.requestDo, (i, v) => {
                total -= row[`${v}VinOld`];
                total -= row[`${v}VinNew`];
            });
        }

        ahmsdlog018p02RequestDoData.rows[index].totalRowsSelisih = total;

        return `<span id="ahmsdlog018p02ManageSelisih${index}">
                    ${ahmsdlog018p02IsDataAlready ? total : row.vinOld + row.vinNew}
                </span>`;
    }

    function ahmsdlog018p02ManageOnChangeVin(event, value, vin, index, columns) {
        const data = ahmsdlog018p02RequestDoData;
        const shipto = data.requestDo[columns];

        const targetValue = ahmsdlog018ParseInt(event.target.value);
        const vinOldValue = data.rows[index].vinOld;
        const vinNewValue = data.rows[index].vinNew;

        const totalVin = ahmsdlog018p02ManageTableCalculateTotalVin(index, vin);

        if(vin === 'Old' && totalVin > vinOldValue) {
            alert("Vin old melebihi distribution plan");
            $(`#${event.target.id}`).val(data.rows[index][`${shipto}VinOld`])
            event.preventDefault();
            return;
        } else if(vin === 'New' && totalVin > vinNewValue) {
            alert("Vin new melebihi distribution plan");
            $(`#${event.target.id}`).val(data.rows[index][`${shipto}VinNew`])
            event.preventDefault();
            return;
        }

        if(vin === 'Old') {
            data.rows[index][`${shipto}VinOld`] = ahmsdlog018ParseInt(targetValue);
            const footerValue = data.rows
                    .reduce((total, value) => total +
                        ahmsdlog018ParseInt(value[`${shipto}VinOld`]), 0);

            $('#ahmsdlog018p02ManageTableVinTotalFooterOld'+columns).text(footerValue);
        } else {
            data.rows[index][`${shipto}VinNew`] = ahmsdlog018ParseInt(targetValue);
            const footerValue = data.rows
                .reduce((total, value) => total +
                    ahmsdlog018ParseInt(value[`${shipto}VinNew`]), 0);

            $('#ahmsdlog018p02ManageTableVinTotalFooterNew'+columns).text(footerValue);
        }

        ahmsdlog018p02RequestApi.shipto = ahmsdlog018p02RequestDoData.requestDo;
        ahmsdlog018p02RequestApi.isUpdate = ahmsdlog018p02IsDataAlready;
    }

    function ahmsdlog018p02ManageTableCalculateTotalVin(index, vin) {
        const data = ahmsdlog018p02RequestDoData;
        let totalVin = 0;

        for (let i = 0; i < data.requestDo.length; i++) {
            const elementValue = $(`#ahmsdlog018p02Do${vin}${index}${i}`).val();

            totalVin += ahmsdlog018ParseInt(elementValue);
        }

        let totalSelisih = 0;
        let totalVinSelisih = 0;
        for (let i = 0; i < data.rows.length; i++) {
            const elementValue = $(`#ahmsdlog018p02ManageTotal${i}`).text();
            const elementValueSelisih = $(`#ahmsdlog018p02ManageSelisih${i}`).text();

            totalSelisih += ahmsdlog018ParseInt(elementValueSelisih);
            totalVinSelisih += ahmsdlog018ParseInt(elementValue);
        }

        $('#ahmsdlog018p02ManageTableVinTotalRowData').text(totalVinSelisih);
        $('#ahmsdlog018p02ManageTableVinTotalRowSelisih').text(totalSelisih);

        return totalVin;
    }

    function ahmsdlog018ParseInt(value) {
        return parseInt(value ? value : 0);
    }

    function ahmsdlog018p02ManageOnUpdate() {
        data.docNumber = 'DPC-202212001';
        data.mdCode = 'G5Z';
        const period = 'Dec-2022';
        let data = ahmsdlog018p02RequestApi;

        $.each(ahmsdlog018p02RequestDoData.rows, (i, v) => {
            $.each(ahmsdlog018p02RequestDoData.requestDo, (j, shipto) => {
                const vinOld = $(`#ahmsdlog018p02DoOld${i}${j}`).val();
                const vinNew = $(`#ahmsdlog018p02DoNew${i}${j}`).val();

                let dataReq = {
                    shipto: shipto,
                    headVinOld : ahmsdlog018p02RequestDoData.rows[i].vinOld,
                    headVinNew: ahmsdlog018p02RequestDoData.rows[i].vinNew,
                    vinOld: ahmsdlog018ParseInt(vinOld),
                    vinNew: ahmsdlog018ParseInt(vinNew),
                    mcTypeId: ahmsdlog018p02RequestDoData.rows[i].mcTypeId,
                    unitGroupId: ahmsdlog018p02RequestDoData.rows[i].unitGroup,
                    colorId: ahmsdlog018p02RequestDoData.rows[i].colorCode,
                    docNumber: docNumber,
                    mdCode: mdCode,
                    month: ahmsdlog018GenerateMonth(period),
                    year: ahmsdlog018GenerateYear(period),
                    sumDpQty: 100,
                    deviation: 2,
                    dpQty: 10
                };

                data.push(dataReq);
            })
        })

        $.ajax({
            url: '/manage-table',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: (res) => {
                console.log(res);
            },
            error: (err) => {
                console.log(err)
            }
        });
    }

    function ahmsdlog018p02PembukaanDoTable() {
        ahmsdlog018p02Columns = 0;

        $.ajax({
            url: '/pembukaan',
            type: 'POST',
            success: (res) => {
                ahmsdlog018p02PembukaanDoData = res;
                $('#ahmsdlog018p02PembukaanDoTableContainer').html(ahmsdlog018p02PembukaanDoTableHead(res));
                const table = $('#ahmsdlog018PembukaanDoTable');

                table.bootstrapTable({
                    data: res.rows
                })
            },
            error: (err) => {
                console.log(err);
            }
        });
    }

    function ahmsdlog018p02PembukaanDoTableHead(data) {
        let template = `
            <table id="ahmsdlog018PembukaanDoTable">
                <thead>
                    <tr>
                        <th data-field="date" data-valign="middle" data-halign="center" data-formatter="ahmsdlog018p02PembukaanDateFormatter"></th>

        `;

        $.each(data.requestDo, (i, v) => {
           template += `
                <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018p02PercepatanQQFormatter">${v}</th>
           `;
        });

        template += '</tr></thead></table>'

        return template;
    }

    function ahmsdlog018p02PembukaanDateFormatter(value, row, index) {
        return ahmsdlog018GenerateFullDateFormat(value);
    }

    function ahmsdlog018p02PercepatanQQFormatter(value, row, index) {
        const data = ahmsdlog018p02PembukaanDoData;
        const lastCol = data.requestDo.length - 1;
        const fieldValue = data.rows[index].data[ahmsdlog018p02Columns].status;
        const today = new Date('2022-12-12');
        const dateValue = new Date(data.rows[index].date);

        let template = `
            <div class="ahmsdlog018p02PercepatanColWrapper">
                <label class="left">No</label>
                <label class="switch" style="border-radius: 50%">
                    <input type="checkbox" onchange="ahmsdlog018p02PercepatanOnChecked(event, ${index}, ${ahmsdlog018p02Columns})"
                        id="ahmsdlog018p02PercepatanData${index}${ahmsdlog018p02Columns}"
                        fieldValue ? 'checked' : ''}
                        ${today >= dateValue ? 'disabled' : ''}
                     />
                    <span class="slider round"></span>
                </label>
                <label class="right">Yes</label>
            </div>
        `;

        if (ahmsdlog018p02Columns == lastCol) {
            ahmsdlog018p02Columns = 0;
            return template;
        }

        ahmsdlog018p02Columns++;

        return template;
    }

    function ahmsdlog018p02PercepatanOnChecked(event, rowTarget, colTarget) {
        const value = event.target.checked;
        ahmsdlog018p02PembukaanDoData.rows[rowTarget].data[colTarget].status = value;
    }

    function ahmsdlog018p02PembukaanDoOnUpdate() {
        let data = ahmsdlog018p02PembukaanDoData;
        data.docNumber = 'DPC-202212001';
        data.mdCode = 'G5Z';

        $.ajax({
            url: '/pembukaan-save',
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            success: (res) => {
                console.log(res);
            },
            error: (err) => {
                console.log(err);
            }
        })
    }

    function ahmsdlog018p02MaintainTable() {
        ahmsdlog018p02Columns = 0;
        const req = {
            docNumber: 'DPC-202212001',
            mdCode: 'G5Z',
            dateMaintain: '2022-12-31'
        }

        $.ajax({
            url: '/maintain',
            type: 'POST',
            data: JSON.stringify(req),
            contentType: 'application/json',
            success: (res) => {
                ahmsdlog018p02MaintainRequestData = res;
                ahmsdlog018p02RequestApi = [];

                $('#ahmsdlog018ManageTableContainer').html(ahmsdlog018p02MaintainTableHead(res));

                const table = $('#ahmsdlog018p02MaintainTable');
                table.bootstrapTable({ data: res.rows });
                ahmsdlog018p02MaintainTableFooter();
            },
            error: (err) => {
                console.log(err)
            }
        });
    }

    function ahmsdlog018p02MaintainTableHead(data) {
        let template = `
            <table id ="ahmsdlog018p02MaintainTable">
                <thead>
                    <tr>
                        <th data-valign="middle" data-halign="center" data-field="unitGroup">Unit Group</th>
                        <th data-valign="middle" data-halign="center" data-field="mcTypeColor">Mc Type Color</th>
                        <th data-valign="middle" data-halign="center" data-field="mcTypeId">Mc Type Code</th>
                        <th data-valign="middle" data-halign="center" data-field="marketingDesc">Marketing Description</th>
                        <th data-valign="middle" data-halign="center" data-field="colorDesc">Color Description</th>
                        <th data-valign="middle" data-halign="center" data-field="percentageReff">% Reff Accum</th>
                        <th data-valign="middle" data-halign="center" data-field="mpsVinOld">Mps Vin Old</th>
                        <th data-valign="middle" data-halign="center" data-field="mpsVinNew">Mps Vin New</th>
                        <th data-valign="middle" data-halign="center" data-field="ddsVinOld">Dds Vin Old</th>
                        <th data-valign="middle" data-halign="center" data-field="ddsVinNew">Dds Vin New</th>
                        ${ahmsdlog018p02MaintainTableQq(data)}
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018MaintainTableTotalPlanDoFormatter">
                            Total Plan Do Open
                        </th>
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018MaintainTableCummulativeFormatter">
                            Cummulative Plan DO Open (tgl 1-hari H)
                        </th>
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018MaintainTableSelisihFormatter">
                            Selisih Terhadap DDS
                        </th>
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018MaintainCumPercentageFormatter">
                            Cummulative Percentage (Unit Group)
                        </th>
                        <th data-valign="middle" data-halign="center" data-formatter="ahmsdlog018MaintainRemarkFormatter">
                            Remark
                        </th>
                        <th data-valign="middle" data-halign="center" data-field="actualDoOpen">
                            Actual DO Open
                        </th>
                  </tr>
              </thead>
          </table>
        `;

        return template;
    }

    function ahmsdlog018p02MaintainTableQq(data) {
        let template = '';

        $.each(data.requestDo, (i, value) => {
            console.log()
            template += `
                <th data-valign="middle" data-halign="center" data-field="${value}HMinVinOld">
                    Sisa Pembukaan (H-1)<br>
                    ${value} Vin Old
                </th>
                <th data-valign="middle" data-halign="center" data-field="${value}HMinVinNew">
                    Sisa Pembukaan (H-1)<br>
                    ${value} Vin New
                </th>

                <th data-valign="middle" data-halign="center" data-field="${value}VinOld" data-formatter="ahmsdlog018p02MaintainTableVinOldFormatter">
                    ${value} Vin Old
                </th>
                <th data-valign="middle" data-halign="center" data-field="${value}VinNew" data-formatter="ahmsdlog018p02MaintainTableVinNewFormatter">
                    ${value} Vin New
                </th>

                <th data-valign="middle" data-halign="center" data-field="${value}HVinOld" data-formatter="ahmsdlog018p02MaintainTableVinOldHFormatter">
                    Sisa Pembukaan (H)<br>
                    ${value} Vin Old
                </th>
                <th data-valign="middle" data-halign="center" data-field="${value}HVinNew" data-formatter="ahmsdlog018p02MaintainTableVinNewHFormatter">
                    Sisa Pembukaan (H)<br>
                    ${value} Vin New
                </th>
           `;
        });

        return template;
    }

    function ahmsdlog018p02MaintainTableVinOldFormatter(value, row, index) {
        return `<input type="number"
                    onchange="ahmsdlog018p02MaintainOnChangeVin(event, value, 'Old', ${index}, ${ahmsdlog018p02Columns})"
                    class="form-control"
                    value="${value ? value : 0}"
                    id="ahmsdlog018p02MaintainDoOld${index}${ahmsdlog018p02Columns}"/>`
    }

    function ahmsdlog018p02MaintainTableVinNewFormatter(value, row, index) {
        const lastCol = ahmsdlog018p02MaintainRequestData.requestDo.length - 1;

        const template = `<input type="number"
                             onchange="ahmsdlog018p02MaintainOnChangeVin(event, value, 'New', ${index}, ${ahmsdlog018p02Columns})"
                             class="form-control"
                             value="${value ? value : 0}"
                             id="ahmsdlog018p02MaintainDoNew${index}${ahmsdlog018p02Columns}"/>`;

        if(ahmsdlog018p02Columns ==  lastCol) {
            ahmsdlog018p02Columns = 0;
        } else {
            ahmsdlog018p02Columns +=1;
        }

        return template;
    }

    function ahmsdlog018p02MaintainTableVinOldHFormatter(value, row, index) {
        return `<span id="ahmsdlog018p02MaintainHMinOld${ahmsdlog018p02Columns}">${value}</span>`;
    }

    function ahmsdlog018p02MaintainTableVinNewHFormatter(value, row, index) {
        return `<span id="ahmsdlog018p02MaintainHMinNew${ahmsdlog018p02Columns}">${value}</span>`;
    }

    function ahmsdlog018MaintainTableTotalPlanDoFormatter(value, row, index) {
        const data = ahmsdlog018p02MaintainRequestData;
        let totalPlanDo = 0;

        $.each(data.requestDo, (i, v) => {
           totalPlanDo += data.rows[i][`${v}VinOld`];
        });

        return `<span id="ahmsdlog018p02MaintainTotalPlanDo${index}">${totalPlanDo}</span>`;
    }

    function ahmsdlog018MaintainTableCummulativeFormatter(value, row, index) {
        return `<span id="ahmsdlog018p02MaintainCummlative${index}">125</span>`;
    }

    function ahmsdlog018MaintainTableSelisihFormatter(value, row, index) {
        let totalDds = row.ddsVinOld + row.ddsVinNew;
        let totalPlanDo = 0;

        $.each(ahmsdlog018p02MaintainRequestData.requestDo, (i, v) => {
            totalPlanDo += ahmsdlog018p02MaintainRequestData.rows[i][`${v}VinOld`];
        });

        return `<span id="ahmsdlog018p02MaintainSelisih${index}">${totalDds - totalPlanDo}</span>`;
    }

    function ahmsdlog018MaintainCumPercentageFormatter(value, row, index) {
        return `<span id="ahmsdlog018p02MaintainSelisih${index}">100%</span>`;
    }

    function ahmsdlog018MaintainRemarkFormatter(value, row, index) {
        return `<input type="text" class="form-control" id="ahmsdlog018p02MaintainRemark${index}" />`;
    }

    function ahmsdlog018p02MaintainTableFooter() {
        const data = ahmsdlog018p02MaintainRequestData;
        const totalDdsVinOld = data.rows
            .reduce((total, value) => total + value.ddsVinOld, 0);

        const totalDdsVinNew = data
            .rows.reduce((total, value) => total + value.ddsVinNew, 0);

        const totalMpsVinOld = data
            .rows.reduce((total, value) => total + value.mpsVinOld, 0);

        const totalMpsVinNew = data
            .rows.reduce((total, value) => total + value.mpsVinNew, 0);

        let footerHtml = `
            <tr>
                <td colspan="6" style="text-align: center; font-weight: 700;">Total</td>
                <td style="font-weight: 700;">${totalMpsVinOld}</td>
                <td style="font-weight: 700;">${totalMpsVinNew}</td>
                <td style="font-weight: 700;">${totalDdsVinOld}</td>
                <td style="font-weight: 700;">${totalDdsVinNew}</td>
        `;

        for (let i = 0; i < data.requestDo.length; i++) {
            const vinOldSum = data.rows
                .reduce((total, value) => total + value[`${data.requestDo[i]}VinOld`], 0);

            const vinNewSum = data.rows
                .reduce((total, value) => total + value[`${data.requestDo[i]}VinNew`], 0);

            const HMinVinOld = data.rows
                .reduce((total, value) => total + value[`${data.requestDo[i]}HMinVinOld`], 0);

            const HMinVinNew = data.rows
                .reduce((total, value) => total + value[`${data.requestDo[i]}HMinVinNew`], 0);

            const HVinOld = data.rows
                .reduce((total, value) => total + value[`${data.requestDo[i]}HVinOld`], 0);

            const HVinNew = data.rows
                .reduce((total, value) => total + value[`${data.requestDo[i]}HVinNew`], 0);

            footerHtml += `
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02MaintainTableHMinVinTotalFooterOld${i}">
                        ${ahmsdlog018p02IsDataAlready ? HMinVinOld : 0}
                    </span>
                </td>
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02MaintainTableHMinVinTotalFooterNew${i}">
                        ${ahmsdlog018p02IsDataAlready ? HMinVinNew : 0}
                    </span>
                </td>
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02MaintainTableVinTotalFooterOld${i}">
                        ${ahmsdlog018p02IsDataAlready ? vinOldSum : 0}
                    </span>
                </td>
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02MaintainTableVinTotalFooterNew${i}">
                        ${ahmsdlog018p02IsDataAlready ? vinNewSum : 0}
                    </span>
                </td>
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02MaintainTableHVinTotalFooterOld${i}">
                        ${ahmsdlog018p02IsDataAlready ? HVinOld : 0}
                    </span>
                </td>
                <td style="font-weight: 700;">
                    <span id="ahmsdlog018p02MaintainTableHVinTotalFooterNew${i}">
                        ${ahmsdlog018p02IsDataAlready ? HVinNew : 0}
                    </span>
                </td>
            `;

            if (i == data.requestDo.length - 1) {
                const ddsVinOldSum = data.rows
                    .reduce((total, value) => total + value.ddsVinOld, 0);

                const ddsVinNewSum = data.rows
                    .reduce((total, value) => total + value.ddsVinNew, 0);

                const actualDoSum = data.rows
                    .reduce((total, value) => total + value.actualDoOpen, 0);

                footerHtml += `
                    <td style="font-weight: 700;">
                        <span id="ahmsdlog018p02MaintainTotalPlanFooter">
                            ${ahmsdlog018p02IsDataAlready ? vinOldSum + vinNewSum : 0}
                        </span>
                    </td>
                    <td></td>
                    <td style="font-weight: 700;">
                        <span id="ahmsdlog018p02MaintainSelisihFooter">
                            ${ahmsdlog018p02IsDataAlready ?
                        (ddsVinOldSum + ddsVinNewSum) - (vinOldSum + vinNewSum) : 0}
                        </span>
                    </td>
                    <td></td>
                    <td></td>
                    <td style="font-weight: 700;">
                        <span id="ahmsdlog018p02MaintainTableActualDoFooter">
                            ${ahmsdlog018p02IsDataAlready ? actualDoSum : 0}
                        </span>
                    </td>
                `;
            }
        }

        footerHtml += "</tr>";

        const table = $('#ahmsdlog018p02MaintainTable tbody tr:last').after(footerHtml);
    }

    function ahmsdlog018p02MaintainOnChangeVin(event, value, vin, index, columns) {
        const data = ahmsdlog018p02MaintainRequestData;
        const shipto = data.requestDo[columns];

        const targetValue = ahmsdlog018ParseInt(event.target.value);
        const vinOldValue = data.rows[index].ddsVinOld;
        const vinNewValue = data.rows[index].ddsVinNew;

        const totalVin = ahmsdlog018p02MaintainTableCalculateTotalVin(index, vin);

        if(vin === 'Old' && totalVin > vinOldValue) {
            alert("Vin old melebihi distribution plan");
            $(`#${event.target.id}`).val(data.rows[index][`${shipto}VinOld`])
            event.preventDefault();
            return;
        } else if(vin === 'New' && totalVin > vinNewValue) {
            alert("Vin new melebihi distribution plan");
            $(`#${event.target.id}`).val(data.rows[index][`${shipto}VinNew`])
            event.preventDefault();
            return;
        }

        if(vin === 'Old') {
            data.rows[index][`${shipto}VinOld`] = ahmsdlog018ParseInt(targetValue);
            const hMinValue = data.rows[index][`${shipto}HMinVinOld`] -
                data.rows[index][`${shipto}VinOld`];

            const footerValue = data.rows
                .reduce((total, value) => total + value[`${shipto}VinOld`], 0);

            $(`#ahmsdlog018p02MaintainHMinOld${columns}`).text(`${hMinValue}`);
            $(`#ahmsdlog018p02MaintainTableVinTotalFooterOld${columns}`).text(footerValue);

            dataReq.doVinOld = ahmsdlog018ParseInt(targetValue);
        } else {
            data.rows[index][`${shipto}VinNew`] = ahmsdlog018ParseInt(targetValue);
            const hMinValue = data.rows[index][`${shipto}HMinVinNew`] -
                data.rows[index][`${shipto}VinNew`];

            const footerValue = data.rows
                .reduce((total, value) => total + value[`${shipto}VinNew`], 0);

            $(`#ahmsdlog018p02MaintainHMinNew${columns}`).text(hMinValue);
            $(`#ahmsdlog018p02MaintainTableVinTotalFooterNew${columns}`).text(footerValue);
        }
    }

    function ahmsdlog018p02MaintainTableCalculateTotalVin(index, vin) {
        const data = ahmsdlog018p02MaintainRequestData;
        let totalVin = 0;

        for (let i = 0; i < data.requestDo.length; i++) {
            const elementValue = $(`#ahmsdlog018p02MaintainDo${vin}${index}${i}`).val();

            totalVin += ahmsdlog018ParseInt(elementValue);
        }

        return totalVin;
    }

    function ahmsdlog018p02MaintainOnUpdate() {
        const data = ahmsdlog018p02MaintainRequestData;
        let request = [];

        if(!request.length) {
            alert('tidak ada perubahan');
        }

        $.each(data.rows, (i, value) => {
            $.each(data.requestDo, (j, v) => {
               const reqData = {
                   docNumber : 'DPC-202212001',
                   mdCode : value.mdCode,
                   mcTypeId :value.mcTypeId,
                   colorId : value.colorId,
                   shipto : v,
                   shiptoMd : 'G5Z',
                   dateMaintain : '2022-12-31',
                   unitGroup : value.unitGroup,
                   doVinOld : value[`${v}VinOld`],
                   doVinNew : value[`${v}VinNew`]
               }

               request.push(reqData);
            });
        });

        $.ajax({
            url: '/maintain-upadata',
            type: 'POST',
            data: JSON.stringify(request),
            contentType: 'application/json',
            success: (res) => {
                console.log(res);
            },
            error: (err) => {
                console.log(err);
            }
        })
    }
</script>
</html>